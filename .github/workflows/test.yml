name: Test Cross-Compilation

on:
  push:
    branches: ["*"]
  pull_request:
    branches: ["*"]
  workflow_dispatch:

jobs:
  # Test basic functionality
  test-basic:
    name: Test Basic Build
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Test help output
        run: bash ./cross.sh --help

      - name: Test show all targets
        run: bash ./cross.sh --show-all-targets

      - name: Build for host target
        run: bash ./cross.sh build

      - name: Test debug profile
        run: bash ./cross.sh build --profile=debug

      - name: Test cross verbose output
        run: bash ./cross.sh build --target=aarch64-unknown-linux-musl --verbose

      - name: Test cross with static CRT
        run: bash ./cross.sh build --target=aarch64-unknown-linux-musl --static-crt=true

      - name: Test cross check command
        run: bash ./cross.sh check --target=aarch64-unknown-linux-musl

  # Test the GitHub Action itself
  test-action:
    name: Test GitHub Action
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, ubuntu-24.04-arm, macos-15, macos-15-intel]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build using action
        uses: ./
        with:
          command: build
          profile: release
          toolchain: nightly
          target: |
            x86_64-unknown-linux-musl
            aarch64-unknown-linux-musl
            armv7-unknown-linux-musleabihf

            x86_64-unknown-linux-gnu
            aarch64-unknown-linux-gnu
            armv7-unknown-linux-gnueabihf

            i686-pc-windows-gnu
            x86_64-pc-windows-gnu

            x86_64-unknown-freebsd
            aarch64-unknown-freebsd
            powerpc64-unknown-freebsd
            powerpc64le-unknown-freebsd
            riscv64gc-unknown-freebsd

            x86_64-apple-darwin
            x86_64h-apple-darwin
            aarch64-apple-darwin
            arm64e-apple-darwin

            x86_64-apple-ios
            aarch64-apple-ios
            aarch64-apple-ios-sim

            i686-linux-android
            x86_64-linux-android
            armv7-linux-androideabi
            arm-linux-androideabi
            aarch64-linux-android
            riscv64-linux-android

  # Test the GitHub Action itself
  test-action-windows:
    name: Test GitHub Action
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build using action
        uses: ./
        with:
          command: build
          profile: release
          toolchain: nightly
          target: |
            x86_64-pc-windows-msvc
            i686-pc-windows-msvc
            aarch64-pc-windows-msvc

            x86_64-pc-windows-gnu
            i686-pc-windows-gnu
            aarch64-pc-windows-gnu
